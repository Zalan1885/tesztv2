<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>KNB Bank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { 
      --brand: purple; 
      --brand-dark:#660066; 
      --success: #2e7d32;
      --error: #c62828;
      --warning: #f57c00;
    }
    body { font-family: Arial, sans-serif; background:#fff; color:var(--brand); margin:0; padding:20px; }
    .container { max-width:1200px; margin:0 auto; }
    .header { text-align:center; padding:20px; border-bottom:2px solid var(--brand); margin-bottom:20px; }
    .form-group { margin-bottom:12px; }
    input, textarea, select {
      width:100%; padding:10px; border:1px solid var(--brand); border-radius:4px; box-sizing:border-box;
    }
    button {
      width:100%; padding:10px 16px; border:0; border-radius:4px; background:var(--brand); color:#fff; cursor:pointer;
    }
    button:hover { background:var(--brand-dark); }
    button:disabled { background:#bbb; cursor:not-allowed; }
    button.small { width:auto; padding:6px 12px; font-size:0.9em; }
    button.quick-amount { width:80px; margin:4px; background:var(--warning); }
    button.quick-amount:hover { background:#e65100; }
    .hidden { display:none; }
    .row { display:flex; gap:20px; }
    .col { flex:1; }
    #userInfo { padding:12px; border:1px solid var(--brand); border-radius:6px; position: relative; }
    .tab-buttons { display:flex; gap:10px; margin:16px 0; }
    .tab-buttons button { flex:1; }
    .panel { padding:12px; border:1px solid var(--brand); border-radius:6px; background:#fafafa; }
    .transactions-panel { max-height:600px; overflow:auto; }
    .transaction-item {
      background:#fff; border-left:4px solid var(--brand); margin:10px 0; padding:10px; border-radius:6px;
      box-shadow:0 2px 4px rgba(0,0,0,.08);
    }
    .transaction-item .amount { font-weight:bold; margin:6px 0; }
    .positive { color:var(--success); } 
    .negative { color:var(--error); }
    .date { color:#555; font-size:.9em; }
    .notification {
      position:fixed; top:20px; right:20px; padding:12px 16px; border-radius:6px; display:none; z-index:999;
      color:#fff;
    }
    .success { background:var(--success); } 
    .error { background:var(--error); } 
    .info { background:#1976d2; }

    /* lists */
    .list { display:flex; flex-direction:column; gap:8px; }
    .list-item {
      background:#fff; border:1px solid #e6d9f5; border-radius:6px; padding:10px;
      display:flex; flex-wrap:wrap; align-items:center; gap:10px; justify-content:space-between;
    }
    .actions { display:flex; gap:8px; }
    .split { display:flex; gap:20px; }
    .muted { color:#666; }
    .badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:.85em; background:#eee; color:#333; }
    .badge.favorite { background:gold; color:#333; }
    
    /* QR Code */
    .qr-section { text-align: center; margin: 10px 0; }
    #qrcode { margin: 10px auto; }
    
    /* Filters */
    .filters { 
      display:flex; gap:10px; margin:10px 0; flex-wrap:wrap; align-items:center;
      padding:10px; background:#f5f5f5; border-radius:6px;
    }
    .filters > * { flex:1; min-width:120px; }
    
    /* Stats */
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin:15px 0; }
    .stat-card { 
      background:#fff; padding:15px; border-radius:8px; border-left:4px solid var(--brand); 
      box-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    .stat-value { font-size:1.5em; font-weight:bold; color:var(--brand); }
    .stat-label { font-size:0.9em; color:#666; margin-top:5px; }
    
    /* Favorites heart icon */
    .heart { cursor:pointer; font-size:1.2em; user-select:none; }
    .heart.favorited { color:red; }
    .heart:hover { color:red; }
    
    /* Quick amounts */
    .quick-amounts { display:flex; gap:8px; margin:10px 0; justify-content:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <div id="notification" class="notification"></div>

  <div class="container">
    <div class="header">
      <h1>KNB Bank</h1>
      <p>√údv a KNB-ben ‚Äì A k√°rtyak√≥d vagy jelszavad v√°lt√≥ztat√°s√°√©rt √≠rj priv√°tban</p>
    </div>

    <!-- Loading -->
    <div id="loadingScreen"><h3>Kapcsol√≥d√°s az adatb√°zishoz‚Ä¶</h3></div>

    <!-- Auth -->
    <div id="authForms" class="hidden">
      <div class="tab-buttons">
        <button onclick="showTab('loginForm')" id="loginTab">Bejelentkez√©s</button>
        <button onclick="showTab('registrationForm')" id="registrationTab">Regisztr√°ci√≥</button>
      </div>

      <div id="loginForm">
        <h2>Bejelentkez√©s</h2>
        <div class="form-group"><input type="text" id="cardNumber" placeholder="K√°rtyasz√°m"></div>
        <div class="form-group"><input type="password" id="pin" placeholder="PIN k√≥d"></div>
        <button onclick="login()">Bel√©p√©s</button>
      </div>

      <div id="registrationForm" class="hidden">
        <h2>Regisztr√°ci√≥</h2>
        <div class="form-group"><input type="text" id="regName" placeholder="Teljes n√©v"></div>
        <div class="form-group"><input type="password" id="regPin" placeholder="PIN (4 sz√°mjegy)"></div>
        <div class="form-group"><input type="password" id="regPinConfirm" placeholder="PIN meger≈ës√≠t√©se"></div>
        <button onclick="register()">Regisztr√°ci√≥</button>
      </div>
    </div>

    <!-- App -->
    <div id="bankInterface" class="hidden">
      <div class="row">
        <div class="col">
          <div id="userInfo" class="panel">
            <h3>Felhaszn√°l√≥i inform√°ci√≥k</h3>
            <p>N√©v: <strong id="displayName"></strong></p>
            <p>K√°rtyasz√°m: <strong id="displayCardNumber"></strong></p>
            <p>Egyenleg: <strong id="balance"></strong> JG</p>
            
            <!-- QR k√≥d gener√°tor -->
            <div class="qr-section">
              <button class="small" onclick="generateQR()">Alap QR k√≥d</button>
              <button class="small" onclick="showQRAmountInput()">QR k√≥d √∂sszeggel</button>
              <div id="qrAmountInput" style="display:none; margin:8px 0;">
                <input type="number" id="qrRequestAmount" placeholder="K√©rt √∂sszeg (JG)" style="width:150px;">
                <button class="small" onclick="generateQRWithSpecificAmount()">Gener√°l√°s</button>
              </div>
              <div id="qrcode"></div>
              <p id="qrDescription" class="muted" style="margin-top:8px;"></p>
            </div>
          </div>

          <!-- Statisztik√°k -->
          <div id="statsPanel" class="panel hidden">
            <h3>Statisztik√°k</h3>
            <div class="stats-grid" id="statsGrid"></div>
          </div>

          <div class="tab-buttons" id="userTabs">
            <button onclick="showUserTab('transferTab')" id="t1">√Åtutal√°s</button>
            <button onclick="showUserTab('requestTab')" id="t2">P√©nz k√©r√©se</button>
            <button onclick="showUserTab('directoryTab')" id="t3">Felhaszn√°l√≥k</button>
            <button onclick="showUserTab('favoritesTab')" id="t4">Kedvencek</button>
            <button onclick="showUserTab('settingsTab')" id="t5">Be√°ll√≠t√°sok</button>
            <button onclick="showUserTab('statsTab')" id="t6">Statisztik√°k</button>
          </div>

          <!-- Transfer -->
          <div id="transferTab" class="panel">
            <h3>√Åtutal√°s</h3>
            <div class="form-group">
              <input type="text" id="recipientCard" placeholder="C√≠mzett k√°rtyasz√°ma" list="recipientSuggestions">
              <datalist id="recipientSuggestions"></datalist>
            </div>
            <div class="form-group">
              <input type="number" id="amount" placeholder="√ñsszeg (JG)">
              <div class="quick-amounts">
                <button class="quick-amount" onclick="setQuickAmount(500)">500</button>
                <button class="quick-amount" onclick="setQuickAmount(1000)">1K</button>
                <button class="quick-amount" onclick="setQuickAmount(2000)">2K</button>
                <button class="quick-amount" onclick="setQuickAmount(5000)">5K</button>
              </div>
            </div>
            <button onclick="transfer()">√Åtutal√°s</button>
          </div>

          <!-- Request Money -->
          <div id="requestTab" class="panel hidden">
            <h3>P√©nz k√©r√©se</h3>
            <div class="form-group"><input type="number" id="requestAmount" placeholder="K√©rt √∂sszeg (JG)"></div>
            <div class="form-group"><textarea id="requestReason" placeholder="Indokl√°s"></textarea></div>
            <button onclick="requestMoney()">K√©r√©s elk√ºld√©se</button>
          </div>

          <!-- Directory -->
          <div id="directoryTab" class="panel hidden">
            <h3>Felhaszn√°l√≥k n√©vjegyz√©ke</h3>
            <div class="form-group">
              <input type="text" id="userSearch" placeholder="Keres√©s n√©v vagy k√°rtyasz√°m alapj√°n..." oninput="filterUsers()">
            </div>
            <div id="directoryList" class="list"></div>
          </div>

          <!-- Favorites -->
          <div id="favoritesTab" class="panel hidden">
            <h3>Kedvenc felhaszn√°l√≥k</h3>
            <div id="favoritesList" class="list"></div>
          </div>

          <!-- Settings -->
          <div id="settingsTab" class="panel hidden">
            <h3>Be√°ll√≠t√°sok</h3>
            
            <div class="form-group">
              <label>Email c√≠m (√©rtes√≠t√©sekhez):</label>
              <input type="email" id="userEmail" placeholder="pelda@email.com">
              <button onclick="saveEmail()" class="small" style="margin-top:8px;">Email ment√©se</button>
            </div>
            
            <div style="margin-top:20px;">
              <label>
                <input type="checkbox" id="emailNotifications" onchange="toggleEmailNotifications()">
                Email √©rtes√≠t√©sek bekapcsol√°sa
              </label>
            </div>
            
            <div style="margin-top:20px;">
              <h4>QR k√≥d kezel√©s</h4>
              <p class="muted">A QR k√≥ddal m√°sok k√∂nnyen tudnak neked p√©nzt k√ºldeni. Csak olvasd be a QR k√≥dot √©s add √°t!</p>
              <button onclick="generateQRWithAmount()" class="small">QR k√≥d k√©sz√≠t√©se √∂sszeggel</button>
              <div class="form-group">
                <input type="number" id="qrAmount" placeholder="K√©rt √∂sszeg (JG)" style="display:none;">
              </div>
            </div>
          </div>

          <!-- Stats Tab -->
          <div id="statsTab" class="panel hidden">
            <h3>R√©szletes statisztik√°k</h3>
            <div class="stats-grid" id="detailedStats"></div>
          </div>

          <button onclick="logout()" style="margin-top:16px;">Kijelentkez√©s</button>
        </div>

        <!-- Transactions -->
        <div class="col" style="max-width:380px;">
          <div class="panel transactions-panel">
            <h3>Tranzakci√≥k</h3>
            
            <!-- Transaction Filters -->
            <div class="filters">
              <select id="typeFilter" onchange="filterTransactions()">
                <option value="">Minden t√≠pus</option>
                <option value="transfer_sent">K√ºld√∂tt</option>
                <option value="transfer_received">Kapott</option>
                <option value="admin_credit">Admin j√≥v√°√≠r√°s</option>
                <option value="admin_debit">Admin levon√°s</option>
                <option value="money_request">P√©nzk√©r√©s</option>
              </select>
              
              <select id="dateFilter" onchange="filterTransactions()">
                <option value="">Minden id≈ë</option>
                <option value="today">Ma</option>
                <option value="week">Ez a h√©t</option>
                <option value="month">Ez a h√≥nap</option>
              </select>
            </div>
            
            <div id="transactionsList"><p class="muted">Nincsenek tranzakci√≥k</p></div>
          </div>
        </div>
      </div>

      <!-- Admin Panel -->
      <div id="adminPanel" class="panel hidden" style="margin-top:20px;">
        <h2>Admin fel√ºlet</h2>

        <div class="split">
          <div class="col">
            <h3>Felhaszn√°l√≥k (egyenleggel)</h3>
            <div class="form-group"><input type="text" id="adminUserSearch" placeholder="Keres√©s n√©v vagy k√°rtyasz√°m alapj√°n" oninput="filterAdminUsers()" /></div>
            <div id="adminUsersList" class="list"></div>
          </div>

          <div class="col">
            <h3>P√©nzk√©relmek</h3>
            <div id="requestsList" class="list"></div>
          </div>
        </div>

        <h3 style="margin-top:20px;">Tranzakci√≥ napl√≥ (admin szemsz√∂g)</h3>
        <div id="adminTransactions" class="list"></div>
      </div>
    </div>
  </div>

  <!-- QR Code Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    /* ===== Supabase init ===== */
    const supabaseUrl = 'https://jeorhpbjbmfuyqkaztgc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Implb3JocGJqYm1mdXlxa2F6dGdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTMxMTYsImV4cCI6MjA3MTA4OTExNn0.XegR7Cm3yBBVGwxtax1Dv9kDhuMoQRgS-NbFrv8dt68';
    let supabaseClient;
    let currentUser = null;
    let allUsers = [];
    let allTransactions = [];
    let favorites = [];
    const HUF = new Intl.NumberFormat('hu-HU');

    // Jav√≠tott id≈ëform√°z√°s - UTC-b≈ël CET/CEST-be konvert√°l√°s (2 √≥ra hozz√°adva)
    function formatHU(dateStrOrDate) {
      const d = (dateStrOrDate instanceof Date) ? dateStrOrDate : new Date(dateStrOrDate);
      // Hozz√°adunk 2 √≥r√°t a helyes magyar id≈ë√©rt
      const corrected = new Date(d.getTime() + (2 * 60 * 60 * 1000));
      return corrected.toLocaleString('hu-HU', { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit', 
        hour: '2-digit', 
        minute: '2-digit' 
      });
    }

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function byId(id){ return document.getElementById(id); }
    function notify(msg, type='info'){
      const n = byId('notification');
      n.textContent = msg; n.className = `notification ${type}`; n.style.display = 'block';
      setTimeout(()=> n.style.display='none', 3500);
    }

    window.addEventListener('load', async () => {
      try {
        supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        await initDatabase(); // Ensure tables exist
        hide(byId('loadingScreen'));
        show(byId('authForms'));
        showTab('loginForm');
      } catch (e) {
        console.error(e);
        notify('Nem siker√ºlt a kapcsol√≥d√°s.', 'error');
      }
    });

    // Initialize database tables if they don't exist
    async function initDatabase() {
      // Check if favorites table exists, if not we'll work with localStorage
      try {
        await supabaseClient.from('favorites').select('*').limit(1);
      } catch (e) {
        console.log('Favorites t√°bl√°zat nem el√©rhet≈ë, localStorage-t haszn√°lunk');
      }
    }

    /* ===== Auth UI ===== */
    function showTab(tab) {
      ['loginForm','registrationForm'].forEach(id=>hide(byId(id)));
      show(byId(tab));
    }
    function showUserTab(tabId) {
      ['transferTab','requestTab','directoryTab','favoritesTab','settingsTab','statsTab'].forEach(id=>hide(byId(id)));
      show(byId(tabId));
      
      // Load specific data when tabs are shown
      if (tabId === 'favoritesTab') loadFavorites();
      if (tabId === 'statsTab') loadDetailedStats();
      if (tabId === 'settingsTab') loadUserSettings();
    }

    /* ===== Auth actions ===== */
    async function register() {
      const name = byId('regName').value.trim();
      const pin = byId('regPin').value.trim();
      const pin2 = byId('regPinConfirm').value.trim();
      if(!name || !/^\d{4}$/.test(pin) || pin !== pin2){
        notify('√ârv√©nytelen regisztr√°ci√≥s adatok.', 'error'); return;
      }
      const card = await generateUniqueCardNumber();
      const { error } = await supabaseClient.from('users').insert({
        card_number: card, pin, name, balance: 0, is_admin: false
      });
      if(error){ console.error(error); notify('Regisztr√°ci√≥ sikertelen.', 'error'); return; }
      notify(`Sikeres regisztr√°ci√≥. K√°rtyasz√°m: ${card}`, 'success');
      showTab('loginForm');
      byId('cardNumber').value = card;
    }

    async function login() {
      const card = byId('cardNumber').value.trim();
      const pin  = byId('pin').value.trim();
      const { data: user, error } = await supabaseClient
        .from('users').select('*')
        .eq('card_number', card).eq('pin', pin).single();
      if(error || !user){ notify('Hib√°s k√°rtyasz√°m vagy PIN.', 'error'); return; }
      currentUser = user;
      hide(byId('authForms')); show(byId('bankInterface'));
      
      // Fill info
      byId('displayName').textContent = user.name;
      byId('displayCardNumber').textContent = user.card_number;
      byId('balance').textContent = HUF.format(user.balance);
      
      // Load data
      await Promise.all([loadTransactions(), loadDirectory()]);
      loadFavoritesFromStorage();
      loadUserSettings();
      
      if(user.is_admin){ showAdmin(); } else { hide(byId('adminPanel')); }
    }

    function logout(){
      currentUser = null;
      allUsers = [];
      allTransactions = [];
      favorites = [];
      hide(byId('bankInterface')); show(byId('authForms')); showTab('loginForm');
      notify('Kijelentkezve.', 'info');
    }

    /* ===== QR Code Generator ===== */
    function generateQR() {
      const qrDiv = byId('qrcode');
      qrDiv.innerHTML = '';
      
      const qrData = {
        type: 'knb_transfer',
        name: currentUser.name,
        card: currentUser.card_number,
        bank: 'KNB'
      };
      
      try {
        new QRCode(qrDiv, {
          text: JSON.stringify(qrData),
          width: 150,
          height: 150,
          colorDark: "#660066",
          colorLight: "#ffffff"
        });
        byId('qrDescription').textContent = 'Alap QR k√≥d - m√°sok tudnak neked p√©nzt k√ºldeni';
        notify('Alap QR k√≥d gener√°lva!', 'success');
      } catch (e) {
        notify('QR k√≥d gener√°l√°si hiba.', 'error');
      }
    }
    
    function showQRAmountInput() {
      const input = byId('qrAmountInput');
      input.style.display = input.style.display === 'none' ? 'block' : 'none';
    }
    
    function generateQRWithSpecificAmount() {
      const amount = parseFloat(byId('qrRequestAmount').value);
      if (!amount || amount <= 0) {
        notify('Adj meg √©rv√©nyes √∂sszeget!', 'error');
        return;
      }
      
      const qrDiv = byId('qrcode');
      qrDiv.innerHTML = '';
      
      const qrData = {
        type: 'knb_payment_request',
        name: currentUser.name,
        card: currentUser.card_number,
        amount: amount,
        bank: 'KNB',
        message: `${currentUser.name} ${amount} JG-t k√©r t≈ëled`
      };
      
      try {
        new QRCode(qrDiv, {
          text: JSON.stringify(qrData),
          width: 150,
          height: 150,
          colorDark: "#660066",
          colorLight: "#ffffff"
        });
        byId('qrDescription').textContent = `Fizet√©si k√©r√©s: ${HUF.format(amount)} JG`;
        notify('Fizet√©si QR k√≥d gener√°lva!', 'success');
        byId('qrAmountInput').style.display = 'none';
        byId('qrRequestAmount').value = '';
      } catch (e) {
        notify('QR k√≥d gener√°l√°si hiba.', 'error');
      }
    }
    
    function generateQRWithAmount() {
      showUserTab('settingsTab');
      byId('qrAmount').style.display = 'block';
      byId('qrAmount').focus();
    }

    /* ===== Quick Amount Functions ===== */
    function setQuickAmount(amount) {
      byId('amount').value = amount;
    }

    /* ===== Helpers ===== */
    async function generateUniqueCardNumber(){
      const make = () => 'KNB' + Math.floor(100000 + Math.random()*900000);
      let card = make();
      let exists = true;
      while(exists){
        const { data } = await supabaseClient.from('users').select('card_number').eq('card_number', card).maybeSingle();
        if(!data) exists = false; else card = make();
      }
      return card;
    }

    async function recordTransaction(user_id, type, amount, description, related_user=null){
      const { error } = await supabaseClient.from('transactions').insert({
        user_id, transaction_type: type, amount, description, related_user
      });
      if(error) console.error('Tranzakci√≥ ment√©si hiba:', error);
    }

    /* ===== Transactions (user) ===== */
    async function loadTransactions(){
      const { data: txs } = await supabaseClient
        .from('transactions')
        .select('*')
        .eq('user_id', currentUser.card_number)
        .order('created_at', { ascending:false });
      allTransactions = txs || [];
      renderTransactions('transactionsList', allTransactions);
      loadStatistics(); // Update stats when transactions load
    }

    function renderTransactions(containerId, txs){
      const c = byId(containerId);
      if(!txs || txs.length===0){ c.innerHTML = '<p class="muted">Nincsenek tranzakci√≥k</p>'; return; }
      c.innerHTML = txs.map(t=>{
        let cls='positive', sign='+';
        if(t.amount < 0){ cls='negative'; sign=''; }
        return `<div class="transaction-item">
          <div><strong>${escapeHtml(t.description||'Tranzakci√≥')}</strong></div>
          <div class="amount ${cls}">${sign}${HUF.format(t.amount)} JG</div>
          <div class="date">${formatHU(t.created_at)}</div>
          ${t.related_user? `<div class="muted">Kapcsol√≥d√≥: ${escapeHtml(t.related_user)}</div>`:''}
        </div>`;
      }).join('');
    }

    /* ===== Transaction Filters ===== */
    function filterTransactions() {
      const typeFilter = byId('typeFilter').value;
      const dateFilter = byId('dateFilter').value;
      
      let filtered = [...allTransactions];
      
      // Type filter
      if (typeFilter) {
        filtered = filtered.filter(t => t.transaction_type === typeFilter);
      }
      
      // Date filter
      if (dateFilter) {
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        
        filtered = filtered.filter(t => {
          const tDate = new Date(t.created_at);
          
          switch(dateFilter) {
            case 'today':
              return tDate >= today;
            case 'week':
              const weekStart = new Date(today);
              weekStart.setDate(today.getDate() - today.getDay());
              return tDate >= weekStart;
            case 'month':
              const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
              return tDate >= monthStart;
            default:
              return true;
          }
        });
      }
      
      renderTransactions('transactionsList', filtered);
    }

    /* ===== Statistics ===== */
    function loadStatistics() {
      const stats = calculateStats(allTransactions);
      displayStats(stats);
    }

    function calculateStats(txs) {
      const thisMonth = txs.filter(t => {
        const tDate = new Date(t.created_at);
        const now = new Date();
        return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
      });
      
      const thisWeek = txs.filter(t => {
        const tDate = new Date(t.created_at);
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        return tDate >= weekStart;
      });

      return {
        totalTransactions: txs.length,
        monthlyTransactions: thisMonth.length,
        weeklyTransactions: thisWeek.length,
        totalSent: txs.filter(t => t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0),
        totalReceived: txs.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0),
        monthlySpent: thisMonth.filter(t => t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0),
        monthlyReceived: thisMonth.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0)
      };
    }

    function displayStats(stats) {
      // Mini stats for user info
      show(byId('statsPanel'));
      byId('statsGrid').innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${stats.totalTransactions}</div>
          <div class="stat-label">√ñsszes tranzakci√≥</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.monthlyTransactions}</div>
          <div class="stat-label">Havi tranzakci√≥</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${HUF.format(stats.monthlySpent)} JG</div>
          <div class="stat-label">Havi kiad√°s</div>
        </div>
      `;
    }

    function loadDetailedStats() {
      const stats = calculateStats(allTransactions);
      byId('detailedStats').innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${stats.totalTransactions}</div>
          <div class="stat-label">√ñsszes tranzakci√≥</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${HUF.format(stats.totalSent)} JG</div>
          <div class="stat-label">√ñsszes k√ºld√∂tt</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${HUF.format(stats.totalReceived)} JG</div>
          <div class="stat-label">√ñsszes kapott</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${stats.monthlyTransactions}</div>
          <div class="stat-label">Havi tranzakci√≥</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${HUF.format(stats.monthlySpent)} JG</div>
          <div class="stat-label">Havi kiad√°s</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${HUF.format(stats.monthlyReceived)} JG</div>
          <div class="stat-label">Havi bev√©tel</div>
        </div>
      `;
    }

    /* ===== Favorites System ===== */
    function loadFavoritesFromStorage() {
      const stored = localStorage.getItem(`knb_favorites_${currentUser.card_number}`);
      favorites = stored ? JSON.parse(stored) : [];
    }

    function saveFavoritesToStorage() {
      localStorage.setItem(`knb_favorites_${currentUser.card_number}`, JSON.stringify(favorites));
    }

    function toggleFavorite(cardNumber, name) {
      const index = favorites.findIndex(f => f.card_number === cardNumber);
      if (index >= 0) {
        favorites.splice(index, 1);
        notify(`${name} elt√°vol√≠tva a kedvencekb≈ël`, 'info');
      } else {
        favorites.push({ card_number: cardNumber, name: name });
        notify(`${name} hozz√°adva a kedvencekhez`, 'success');
      }
      saveFavoritesToStorage();
      loadDirectory(); // Refresh the directory to update hearts
      if (byId('favoritesTab').classList.contains('hidden') === false) {
        loadFavorites(); // Refresh favorites if we're viewing them
      }
    }

    function isFavorite(cardNumber) {
      return favorites.some(f => f.card_number === cardNumber);
    }

    function loadFavorites() {
      const list = byId('favoritesList');
      if (favorites.length === 0) {
        list.innerHTML = '<p class="muted">M√©g nincsenek kedvenc felhaszn√°l√≥k.</p>';
        return;
      }
      list.innerHTML = favorites.map(f => `
        <div class="list-item">
          <div>
            <strong>${escapeHtml(f.name)}</strong> 
            <span class="badge">${escapeHtml(f.card_number)}</span>
          </div>
          <div class="actions">
            <button onclick="prefillTransfer('${f.card_number}')">K√ºld√©s neki</button>
            <button onclick="toggleFavorite('${f.card_number}', '${escapeHtml(f.name)}')" class="small">Elt√°vol√≠t√°s</button>
          </div>
        </div>
      `).join('');
    }

    /* ===== Directory (user) ===== */
    async function loadDirectory(){
      const { data: users } = await supabaseClient
        .from('users')
        .select('name, card_number')
        .neq('card_number', currentUser.card_number)
        .order('name', { ascending:true });
      allUsers = users || [];
      renderDirectory(allUsers);
      updateRecipientSuggestions();
    }

    function renderDirectory(users) {
      const list = byId('directoryList');
      if(!users || users.length===0){ 
        list.innerHTML = '<p class="muted">M√©g nincsenek m√°s felhaszn√°l√≥k.</p>'; 
        return; 
      }
      list.innerHTML = users.map(u=>{
        const heartClass = isFavorite(u.card_number) ? 'heart favorited' : 'heart';
        return `
          <div class="list-item">
            <div>
              <strong>${escapeHtml(u.name)}</strong> 
              <span class="badge">${escapeHtml(u.card_number)}</span>
              <span class="${heartClass}" onclick="toggleFavorite('${u.card_number}', '${escapeHtml(u.name)}')" title="Kedvencekhez ad√°s/elt√°vol√≠t√°s">‚ô•</span>
            </div>
            <div class="actions">
              <button onclick="prefillTransfer('${u.card_number}')">K√ºld√©s neki</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function updateRecipientSuggestions() {
      const datalist = byId('recipientSuggestions');
      datalist.innerHTML = allUsers.map(u => 
        `<option value="${u.card_number}">${u.name}</option>`
      ).join('');
    }

    function filterUsers() {
      const query = byId('userSearch').value.toLowerCase();
      const filtered = allUsers.filter(u => 
        u.name.toLowerCase().includes(query) || 
        u.card_number.toLowerCase().includes(query)
      );
      renderDirectory(filtered);
    }

    function prefillTransfer(card){ 
      showUserTab('transferTab'); 
      byId('recipientCard').value = card; 
      byId('amount').focus();
    }

    /* ===== Money transfer / request (user) ===== */
    async function transfer(){
      const recipientCard = byId('recipientCard').value.trim();
      const amount = parseFloat(byId('amount').value);
      if(!recipientCard || !amount || amount<=0){ notify('Adj meg √©rv√©nyes √∂sszeget √©s c√≠mzettet.', 'error'); return; }
      if(recipientCard === currentUser.card_number){ notify('Magadnak nem utalhatsz.', 'error'); return; }

      const { data: recipient } = await supabaseClient.from('users').select('*').eq('card_number', recipientCard).maybeSingle();
      if(!recipient){ notify('Nincs ilyen k√°rtyasz√°m.', 'error'); return; }
      if(currentUser.balance < amount){ notify('Nincs el√©g egyenleg.', 'error'); return; }

      // egyenlegek
      await supabaseClient.from('users').update({ balance: currentUser.balance - amount }).eq('card_number', currentUser.card_number);
      await supabaseClient.from('users').update({ balance: recipient.balance + amount }).eq('card_number', recipientCard);

      // tranzakci√≥k
      await recordTransaction(currentUser.card_number, 'transfer_sent', -amount, `√Åtutal√°s ${recipient.name} r√©sz√©re`, recipient.card_number);
      await recordTransaction(recipient.card_number, 'transfer_received', amount, `√Åtutal√°s ${currentUser.name}-t√≥l`, currentUser.card_number);

      // Email √©rtes√≠t√©s k√ºld√©se (ha be van kapcsolva)
      await sendEmailNotification(recipient, 'transfer_received', {
        amount: amount,
        from: currentUser.name,
        fromCard: currentUser.card_number
      });

      currentUser.balance -= amount;
      byId('balance').textContent = HUF.format(currentUser.balance);
      await loadTransactions();
      notify('√Åtutal√°s sikeres.', 'success');
      byId('amount').value = '';
      byId('recipientCard').value = '';
    }

    async function requestMoney(){
      const amount = parseFloat(byId('requestAmount').value);
      const reason = byId('requestReason').value.trim();
      if(!amount || amount<=0 || !reason){ notify('Adj meg √∂sszeget √©s indokl√°st.', 'error'); return; }
      await supabaseClient.from('money_requests').insert({
        user_id: currentUser.card_number, user_name: currentUser.name,
        amount, reason, status: 'pending'
      });
      await recordTransaction(currentUser.card_number, 'money_request', amount, `P√©nzk√©r√©s: ${reason}`, 'admin');
      await loadTransactions();
      notify('P√©nzk√©r√©s elk√ºldve.', 'success');
      byId('requestAmount').value=''; byId('requestReason').value='';
    }

    /* ===== Admin ===== */
    function showAdmin(){
      show(byId('adminPanel'));
      loadAdminUsers();
      loadRequests();
      loadAdminTransactions();
    }

    async function loadAdminUsers(){
      const { data: users } = await supabaseClient
        .from('users')
        .select('name, card_number, balance, is_admin')
        .order('name', { ascending:true });
      renderAdminUsers(users||[]);
    }

    let _adminUsersCache = [];
    function renderAdminUsers(users){
      _adminUsersCache = users;
      const list = byId('adminUsersList');
      if(users.length===0){ list.innerHTML='<p class="muted">Nincs felhaszn√°l√≥.</p>'; return; }
      list.innerHTML = users.map(u=>`
        <div class="list-item">
          <div>
            <strong>${escapeHtml(u.name)}</strong>
            <span class="badge">${escapeHtml(u.card_number)}</span>
            ${u.is_admin ? '<span class="badge">ADMIN</span>' : ''}
            <div class="muted">Egyenleg: ${HUF.format(u.balance)} JG</div>
          </div>
          <div class="actions" style="min-width:320px;">
            <input type="number" placeholder="√ñsszeg (JG)" id="adm_amt_${u.card_number}" style="width:130px;">
            <button onclick="adminCredit('${u.card_number}')">J√≥v√°√≠r</button>
            <button onclick="adminDebit('${u.card_number}')">Levon</button>
          </div>
        </div>
      `).join('');
    }

    function filterAdminUsers(){
      const q = byId('adminUserSearch').value.toLowerCase();
      const filtered = _adminUsersCache.filter(u =>
        u.name.toLowerCase().includes(q) || u.card_number.toLowerCase().includes(q)
      );
      renderAdminUsers(filtered);
    }

    async function adminCredit(card){
      const inp = byId(`adm_amt_${card}`); const amount = parseFloat(inp.value);
      if(!amount || amount<=0){ notify('Adj meg √©rv√©nyes √∂sszeget.', 'error'); return; }
      const { data: u } = await supabaseClient.from('users').select('*').eq('card_number', card).single();
      await supabaseClient.from('users').update({ balance: u.balance + amount }).eq('card_number', card);
      await recordTransaction(card, 'admin_credit', amount, `Admin j√≥v√°√≠r√°s (${currentUser.name})`, currentUser.card_number);
      notify('J√≥v√°√≠r√°s k√©sz.', 'success'); inp.value='';
      if(card === currentUser.card_number){ currentUser.balance += amount; byId('balance').textContent = HUF.format(currentUser.balance); }
      await Promise.all([loadAdminUsers(), loadAdminTransactions()]);
    }

    async function adminDebit(card){
      const inp = byId(`adm_amt_${card}`); const amount = parseFloat(inp.value);
      if(!amount || amount<=0){ notify('Adj meg √©rv√©nyes √∂sszeget.', 'error'); return; }
      const { data: u } = await supabaseClient.from('users').select('*').eq('card_number', card).single();
      const newBal = (u.balance - amount);
      await supabaseClient.from('users').update({ balance: newBal }).eq('card_number', card);
      await recordTransaction(card, 'admin_debit', -amount, `Admin levon√°s (${currentUser.name})`, currentUser.card_number);
      notify('Levon√°s k√©sz.', 'success'); inp.value='';
      if(card === currentUser.card_number){ currentUser.balance -= amount; byId('balance').textContent = HUF.format(currentUser.balance); }
      await Promise.all([loadAdminUsers(), loadAdminTransactions()]);
    }

    async function loadRequests(){
      const { data: reqs } = await supabaseClient
        .from('money_requests')
        .select('*')
        .order('created_at', { ascending:false });
      const list = byId('requestsList');
      if(!reqs || reqs.length===0){ list.innerHTML = '<p class="muted">Nincs p√©nzk√©relem.</p>'; return; }
      list.innerHTML = reqs.map(r=>`
        <div class="list-item">
          <div>
            <strong>${escapeHtml(r.user_name)}</strong>
            <span class="badge">${escapeHtml(r.user_id)}</span>
            <div>K√©rt √∂sszeg: <strong>${HUF.format(r.amount)} JG</strong></div>
            <div class="muted">${escapeHtml(r.reason || '')}</div>
            <div class="muted">Kelte: ${formatHU(r.created_at)}</div>
            <div>St√°tusz: <span class="badge">${escapeHtml(r.status)}</span></div>
          </div>
          <div class="actions">
            <button onclick="approveRequest('${r.id}','${r.user_id}','${encodeURIComponent(r.user_name)}',${r.amount})" ${r.status!=='pending'?'disabled':''}>J√≥v√°hagy</button>
            <button onclick="rejectRequest('${r.id}')" ${r.status!=='pending'?'disabled':''}>Elutas√≠t</button>
          </div>
        </div>
      `).join('');
    }

    async function approveRequest(id, user_id, user_name_enc, amount){
      const user_name = decodeURIComponent(user_name_enc);
      // update status
      await supabaseClient.from('money_requests').update({ status: 'approved' }).eq('id', id);
      // update balance
      const { data: u } = await supabaseClient.from('users').select('*').eq('card_number', user_id).single();
      await supabaseClient.from('users').update({ balance: u.balance + amount }).eq('card_number', user_id);
      // transactions
      await recordTransaction(user_id, 'request_approved', amount, `K√©relem j√≥v√°hagyva (${currentUser.name})`, currentUser.card_number);
      
      // Email √©rtes√≠t√©s
      const { data: requestUser } = await supabaseClient.from('users').select('*').eq('card_number', user_id).single();
      await sendEmailNotification(requestUser, 'request_approved', {
        amount: amount,
        approver: currentUser.name
      });
      
      notify(`K√©relem j√≥v√°hagyva: ${user_name}`, 'success');
      await Promise.all([loadRequests(), loadAdminUsers(), loadAdminTransactions()]);
    }

    async function rejectRequest(id){
      await supabaseClient.from('money_requests').update({ status: 'rejected' }).eq('id', id);
      notify('K√©relem elutas√≠tva.', 'info');
      await loadRequests();
    }

    async function loadAdminTransactions(){
      const { data: txs } = await supabaseClient
        .from('transactions')
        .select('*')
        .or('transaction_type.eq.admin_credit,transaction_type.eq.admin_debit,transaction_type.eq.request_approved')
        .order('created_at', { ascending:false })
        .limit(100);
      renderTransactions('adminTransactions', txs || []);
    }

    /* ===== Utils ===== */
    function loadUserSettings() {
      const email = localStorage.getItem(`knb_email_${currentUser.card_number}`);
      const notifications = localStorage.getItem(`knb_notifications_${currentUser.card_number}`) === 'true';
      
      if (email) byId('userEmail').value = email;
      byId('emailNotifications').checked = notifications;
    }
    
    function saveEmail() {
      const email = byId('userEmail').value.trim();
      if (!email || !isValidEmail(email)) {
        notify('√ârv√©nyes email c√≠met adj meg!', 'error');
        return;
      }
      
      localStorage.setItem(`knb_email_${currentUser.card_number}`, email);
      notify('Email c√≠m mentve!', 'success');
    }
    
    function toggleEmailNotifications() {
      const enabled = byId('emailNotifications').checked;
      localStorage.setItem(`knb_notifications_${currentUser.card_number}`, enabled);
      
      if (enabled && !byId('userEmail').value.trim()) {
        notify('El≈ësz√∂r add meg az email c√≠med!', 'warning');
        byId('emailNotifications').checked = false;
        return;
      }
      
      notify(`Email √©rtes√≠t√©sek ${enabled ? 'bekapcsolva' : 'kikapcsolva'}`, 'info');
    }
    
    function isValidEmail(email) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }
    
    async function sendEmailNotification(user, type, data) {
      // Ellen≈ërizz√ºk, hogy van-e email √©s be van-e kapcsolva az √©rtes√≠t√©s
      const userEmail = localStorage.getItem(`knb_email_${user.card_number}`);
      const notificationsEnabled = localStorage.getItem(`knb_notifications_${user.card_number}`) === 'true';
      
      if (!userEmail || !notificationsEnabled) return;
      
      let subject, message;
      
      switch(type) {
        case 'transfer_received':
          subject = 'KNB Bank - Bej√∂v≈ë √°tutal√°s';
          message = `
            <h2>P√©nz √©rkezett a sz√°ml√°j√°ra!</h2>
            <p><strong>K√ºld≈ë:</strong> ${data.from} (${data.fromCard})</p>
            <p><strong>√ñsszeg:</strong> ${HUF.format(data.amount)} JG</p>
            <p><strong>Id≈ëpont:</strong> ${formatHU(new Date())}</p>
            <hr>
            <p><em>KNB Bank - Az √ñn megb√≠zhat√≥ bankja</em></p>
          `;
          break;
        case 'request_approved':
          subject = 'KNB Bank - P√©nzk√©r√©s j√≥v√°hagyva';
          message = `
            <h2>P√©nzk√©r√©se j√≥v√°hagy√°sra ker√ºlt!</h2>
            <p><strong>J√≥v√°hagyta:</strong> ${data.approver}</p>
            <p><strong>√ñsszeg:</strong> ${HUF.format(data.amount)} JG</p>
            <p><strong>Id≈ëpont:</strong> ${formatHU(new Date())}</p>
            <hr>
            <p><em>KNB Bank - Az √ñn megb√≠zhat√≥ bankja</em></p>
          `;
          break;
      }
      
      // Val√≥s emailben ez egy API h√≠v√°s lenne (pl. EmailJS, SendGrid, stb.)
      // Most szimul√°lunk egy email k√ºld√©st
      try {
        // Szimul√°ci√≥ - val√≥s√°gban itt t√∂rt√©nne az email k√ºld√©s
        console.log(`üìß Email k√ºld√©s szimul√°lva:`);
        console.log(`C√≠mzett: ${userEmail}`);
        console.log(`T√°rgy: ${subject}`);
        console.log(`Tartalom: ${message}`);
        
        // Ha val√≥s email k√ºld√©st akarn√°nk, itt haszn√°lhatn√°nk pl. EmailJS-t:
        // await emailjs.send('service_id', 'template_id', {
        //   to_email: userEmail,
        //   subject: subject,
        //   message: message
        // });
        
      } catch (error) {
        console.error('Email k√ºld√©si hiba:', error);
      }
    }
    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' }[m]));
    }
  </script>
</body>
</html>
