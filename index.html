<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>KNB Bank</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: white;
            color: purple;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            padding: 20px;
            border-bottom: 2px solid purple;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        input, textarea {
            padding: 8px;
            margin: 5px 0;
            width: 100%;
            border: 1px solid purple;
            box-sizing: border-box;
        }
        button {
            background-color: purple;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            width: 100%;
            margin: 5px 0;
        }
        button:hover {
            background-color: #660066;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .hidden {
            display: none;
        }
        #userInfo {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid purple;
            border-radius: 5px;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-buttons button {
            width: auto;
            flex: 1;
        }
        .active-tab {
            background-color: #660066;
        }
        .notification {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            max-width: 300px;
            z-index: 1000;
        }
        .success {
            background-color: #4CAF50;
            color: white;
        }
        .error {
            background-color: #f44336;
            color: white;
        }
        .card-number-display {
            background-color: #f0e6ff;
            border: 2px solid purple;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .request-list {
            margin-top: 20px;
            border: 1px solid purple;
            padding: 10px;
            border-radius: 5px;
        }
        .request-item {
            background-color: #f0e6ff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .button-group button {
            flex: 1;
        }
        .user-item {
            padding: 5px 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .user-item:hover {
            background-color: #e6ffe6;
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }
        .suggestion-item:hover {
            background-color: #f0e6ff;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <!-- √ârtes√≠t√©sek kont√©nere -->
    <div id="notification" class="notification"></div>

    <div class="container">
        <div class="header">
            <h1>KNB Bank</h1>
            <p>√údv√∂z√∂lj√ºk a KNB Bankban! - A Te Jukasgaras (JG) Bankod</p>
        </div>

        <div id="loadingScreen" class="loading">
            <h3>Kapcsol√≥d√°s az adatb√°zishoz...</h3>
        </div>

        <div id="authForms" class="hidden">
            <div class="tab-buttons">
                <button onclick="showTab('loginForm')" id="loginTab">Bejelentkez√©s</button>
                <button onclick="showTab('registrationForm')" id="registrationTab">Regisztr√°ci√≥</button>
            </div>

            <div id="registrationSuccess" class="hidden">
                <div style="background-color: #e6ffe6; border: 2px solid #4CAF50; color: #4CAF50; padding: 20px; margin: 20px 0; text-align: center; border-radius: 10px;">
                    <h3>Sikeres Regisztr√°ci√≥! üéâ</h3>
                    <p>K√©rj√ºk, jegyezd fel az al√°bbi adatokat:</p>
                </div>
                <div class="card-number-display">
                    <p>A Te k√°rtyasz√°mod:</p>
                    <h2 id="newCardNumberDisplay" style="color: #660066; font-size: 2em;"></h2>
                    <p>Ezzel a k√°rtyasz√°mmal √©s a megadott PIN k√≥ddal tudsz bejelentkezni.</p>
                </div>
                <button onclick="showTab('loginForm')" style="margin-top: 20px;">Tov√°bb a bejelentkez√©shez</button>
            </div>

            <div id="loginForm">
                <h2>Bejelentkez√©s</h2>
                <div class="form-group">
                    <input type="text" id="cardNumber" placeholder="K√°rtyasz√°m">
                </div>
                <div class="form-group">
                    <input type="password" id="pin" placeholder="PIN k√≥d">
                </div>
                <button onclick="login()">Bejelentkez√©s</button>
            </div>

            <div id="registrationForm" class="hidden">
                <h2>Regisztr√°ci√≥</h2>
                <div class="form-group">
                    <input type="text" id="regName" placeholder="Teljes n√©v">
                </div>
                <div class="form-group">
                    <input type="password" id="regPin" placeholder="PIN k√≥d (4 sz√°mjegy)">
                </div>
                <div class="form-group">
                    <input type="password" id="regPinConfirm" placeholder="PIN k√≥d meger≈ës√≠t√©se">
                </div>
                <button onclick="register()">Regisztr√°ci√≥</button>
            </div>
        </div>

        <div id="bankInterface" class="hidden">
            <div id="userInfo">
                <h3>Felhaszn√°l√≥i inform√°ci√≥k</h3>
                <p>N√©v: <span id="displayName"></span></p>
                <p>K√°rtyasz√°m: <span id="displayCardNumber"></span></p>
                <p>Egyenleg: <span id="balance"></span> JG</p>
            </div>

            <div id="userTabs" class="tab-buttons hidden">
                <button onclick="showBankTab('transferForm')" id="transferTabBtn">√Åtutal√°s</button>
                <button onclick="showBankTab('requestForm')" id="requestTabBtn">P√©nz k√©r√©se</button>
            </div>

            <div id="transferForm">
                <h3>√Åtutal√°s</h3>
                <div class="form-group">
                    <input type="text" id="recipientCard" placeholder="C√≠mzett k√°rtyasz√°ma" oninput="searchUsers(this.value)">
                    <div id="userSuggestions" style="max-height: 150px; overflow-y: auto; border: 1px solid purple; background: white; position: relative; z-index: 100;"></div>
                </div>
                <div class="form-group">
                    <input type="number" id="amount" placeholder="√ñsszeg (JG)">
                </div>
                <button onclick="transfer()">√Åtutal√°s</button>
                
                <div style="margin-top: 20px;">
                    <h4>El√©rhet≈ë felhaszn√°l√≥k:</h4>
                    <div id="usersList" style="max-height: 200px; overflow-y: auto; border: 1px solid purple; padding: 10px; background-color: #f9f9f9;">
                        <p>Bet√∂lt√©s...</p>
                    </div>
                </div>
            </div>

            <div id="requestForm" class="hidden">
                <h3>P√©nz k√©r√©se az Admint√≥l</h3>
                <div class="form-group">
                    <input type="number" id="requestAmount" placeholder="K√©rt √∂sszeg (JG)">
                </div>
                <div class="form-group">
                    <textarea id="requestReason" placeholder="K√©r√©s indokl√°sa" rows="3"></textarea>
                </div>
                <button onclick="requestMoney()">K√©r√©s k√ºld√©se</button>
            </div>

            <div id="adminPanel" class="hidden">
                <h3>Admin Panel</h3>
                
                <div style="margin-bottom: 30px;">
                    <h4>P√©nz k√ºld√©se felhaszn√°l√≥nak</h4>
                    <div class="form-group">
                        <input type="text" id="userCardNumber" placeholder="Felhaszn√°l√≥ k√°rtyasz√°ma" oninput="searchUsersAdmin(this.value)">
                        <div id="adminUserSuggestions" style="max-height: 150px; overflow-y: auto; border: 1px solid purple; background: white; position: relative; z-index: 100;"></div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="adminAmount" placeholder="√ñsszeg (JG)">
                    </div>
                    <button onclick="adminTransfer()">P√©nz k√ºld√©se</button>
                </div>

                <div style="margin-bottom: 30px;">
                    <h4>P√©nz levon√°sa felhaszn√°l√≥t√≥l</h4>
                    <div class="form-group">
                        <input type="text" id="deductUserCard" placeholder="Felhaszn√°l√≥ k√°rtyasz√°ma" oninput="searchUsersDeduct(this.value)">
                        <div id="deductUserSuggestions" style="max-height: 150px; overflow-y: auto; border: 1px solid purple; background: white; position: relative; z-index: 100;"></div>
                    </div>
                    <div class="form-group">
                        <input type="number" id="deductAmount" placeholder="Levonand√≥ √∂sszeg (JG)">
                    </div>
                    <button onclick="adminDeduct()">P√©nz levon√°sa</button>
                </div>

                <div style="margin-bottom: 30px;">
                    <h4>Felhaszn√°l√≥ adatai</h4>
                    <div class="form-group">
                        <input type="text" id="viewUserCard" placeholder="Felhaszn√°l√≥ k√°rtyasz√°ma" oninput="searchUsersView(this.value)">
                        <div id="viewUserSuggestions" style="max-height: 150px; overflow-y: auto; border: 1px solid purple; background: white; position: relative; z-index: 100;"></div>
                    </div>
                    <button onclick="viewUserAccount()">Felhaszn√°l√≥ megtekint√©se</button>
                </div>

                <div style="margin-bottom: 20px;">
                    <h4>√ñsszes felhaszn√°l√≥:</h4>
                    <div id="allUsersList" style="max-height: 300px; overflow-y: auto; border: 1px solid purple; padding: 10px; background-color: #f9f9f9;">
                        <p>Bet√∂lt√©s...</p>
                    </div>
                </div>

                <div id="moneyRequests" class="request-list">
                    <h3>Be√©rkezett k√©r√©sek</h3>
                    <div id="requestsList"></div>
                </div>
            </div>

            <button onclick="logout()" style="margin-top: 20px;">Kijelentkez√©s</button>
        </div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase konfigur√°ci√≥
        const supabaseUrl = 'https://jeorhpbjbmfuyqkaztgc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Implb3JocGJqYm1mdXlxa2F6dGdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTMxMTYsImV4cCI6MjA3MTA4OTExNn0.XegR7Cm3yBBVGwxtax1Dv9kDhuMoQRgS-NbFrv8dt68';
        
        let supabaseClient;
        let currentUser = null;
        let allUsers = [];

        // Supabase inicializ√°l√°sa
        async function initSupabase() {
            try {
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                return true;
            } catch (error) {
                console.error('Supabase inicializ√°l√°si hiba:', error);
                return false;
            }
        }

        // Inicializ√°l√°s
        window.addEventListener('load', async () => {
            const supabaseReady = await initSupabase();
            if (supabaseReady) {
                await initializeApp();
            } else {
                showNotification('Nem siker√ºlt kapcsol√≥dni az adatb√°zishoz!', 'error');
            }
        });

        async function initializeApp() {
            try {
                // Ellen≈ërizz√ºk, hogy l√©tezik-e az admin felhaszn√°l√≥
                const { data: adminUser } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('card_number', 'admin')
                    .single();

                if (!adminUser) {
                    // Admin l√©trehoz√°sa, ha nem l√©tezik
                    await supabaseClient
                        .from('users')
                        .insert({
                            card_number: 'admin',
                            pin: '5956',
                            name: 'Admin',
                            balance: 999999999,
                            is_admin: true
                        });
                }

                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('authForms').classList.remove('hidden');
                showTab('loginForm');
            } catch (error) {
                showNotification('Hiba az adatb√°zis kapcsolatn√°l: ' + error.message, 'error');
                console.error('Init hiba:', error);
            }
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        function showTab(tabName) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registrationForm').classList.add('hidden');
            document.getElementById('registrationSuccess').classList.add('hidden');
            document.getElementById(tabName).classList.remove('hidden');

            document.getElementById('loginTab').classList.remove('active-tab');
            document.getElementById('registrationTab').classList.remove('active-tab');
            if (tabName !== 'registrationSuccess') {
                document.getElementById(tabName === 'loginForm' ? 'loginTab' : 'registrationTab').classList.add('active-tab');
            }
        }

        function showBankTab(tabName) {
            document.getElementById('transferForm').classList.add('hidden');
            document.getElementById('requestForm').classList.add('hidden');
            document.getElementById(tabName).classList.remove('hidden');

            document.getElementById('transferTabBtn').classList.remove('active-tab');
            document.getElementById('requestTabBtn').classList.remove('active-tab');
            document.getElementById(tabName === 'transferForm' ? 'transferTabBtn' : 'requestTabBtn').classList.add('active-tab');
        }

        async function register() {
            const name = document.getElementById('regName').value;
            const pin = document.getElementById('regPin').value;
            const pinConfirm = document.getElementById('regPinConfirm').value;

            if (!name || !pin || !pinConfirm) {
                showNotification('K√©rj√ºk, t√∂lts ki minden mez≈ët!', 'error');
                return;
            }

            if (pin !== pinConfirm) {
                showNotification('A PIN k√≥dok nem egyeznek!', 'error');
                return;
            }

            if (pin.length !== 4 || isNaN(pin)) {
                showNotification('A PIN k√≥dnak 4 sz√°mjegyb≈ël kell √°llnia!', 'error');
                return;
            }

            try {
                // √öj k√°rtyasz√°m gener√°l√°sa
                let newCardNumber;
                let attempts = 0;
                do {
                    newCardNumber = Math.floor(Math.random() * 1000) + 1;
                    const { data: existingUser } = await supabaseClient
                        .from('users')
                        .select('card_number')
                        .eq('card_number', newCardNumber.toString())
                        .single();
                    
                    if (!existingUser) break;
                    attempts++;
                } while (attempts < 10);

                if (attempts >= 10) {
                    showNotification('Hiba a k√°rtyasz√°m gener√°l√°sn√°l!', 'error');
                    return;
                }

                // Felhaszn√°l√≥ besz√∫r√°sa az adatb√°zisba
                const { error } = await supabaseClient
                    .from('users')
                    .insert({
                        card_number: newCardNumber.toString(),
                        pin: pin,
                        name: name,
                        balance: 0,
                        is_admin: false
                    });

                if (error) {
                    showNotification('Regisztr√°ci√≥s hiba: ' + error.message, 'error');
                    return;
                }

                document.getElementById('newCardNumberDisplay').textContent = newCardNumber;
                showTab('registrationSuccess');
                
                // Form mez≈ëk t√∂rl√©se
                document.getElementById('regName').value = '';
                document.getElementById('regPin').value = '';
                document.getElementById('regPinConfirm').value = '';

            } catch (error) {
                showNotification('Hiba a regisztr√°ci√≥ sor√°n: ' + error.message, 'error');
            }
        }

        async function login() {
            const cardNumber = document.getElementById('cardNumber').value;
            const pin = document.getElementById('pin').value;

            if (!cardNumber || !pin) {
                showNotification('K√©rj√ºk, add meg a k√°rtyasz√°mod √©s PIN k√≥dodat!', 'error');
                return;
            }

            try {
                const { data: user, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('card_number', cardNumber)
                    .eq('pin', pin)
                    .single();

                if (error || !user) {
                    showNotification('Hib√°s k√°rtyasz√°m vagy PIN k√≥d!', 'error');
                    return;
                }

                currentUser = user;
                showBankInterface(user.is_admin);
                showNotification('Sikeres bejelentkez√©s!', 'success');

            } catch (error) {
                showNotification('Bejelentkez√©si hiba: ' + error.message, 'error');
            }
        }

        function showBankInterface(isAdmin) {
            document.getElementById('authForms').classList.add('hidden');
            document.getElementById('bankInterface').classList.remove('hidden');
            if (isAdmin) {
                document.getElementById('adminPanel').classList.remove('hidden');
                loadMoneyRequests();
                loadAllUsers();
            } else {
                document.getElementById('userTabs').classList.remove('hidden');
                loadUsers();
            }
            updateUserInfo();
            showBankTab('transferForm');
        }

        function updateUserInfo() {
            document.getElementById('displayName').textContent = currentUser.name;
            document.getElementById('displayCardNumber').textContent = currentUser.card_number;
            document.getElementById('balance').textContent = currentUser.balance;
        }

        async function refreshUserBalance() {
            try {
                const { data: user } = await supabaseClient
                    .from('users')
                    .select('balance')
                    .eq('card_number', currentUser.card_number)
                    .single();
                
                if (user) {
                    currentUser.balance = user.balance;
                    updateUserInfo();
                }
            } catch (error) {
                console.error('Egyenleg friss√≠t√©si hiba:', error);
            }
        }

        async function transfer() {
            const recipientCard = document.getElementById('recipientCard').value;
            const amount = parseFloat(document.getElementById('amount').value);

            if (!recipientCard || amount <= 0 || isNaN(amount)) {
                showNotification('K√©rj√ºk, adj meg √©rv√©nyes adatokat!', 'error');
                return;
            }

            try {
                // C√≠mzett ellen≈ërz√©se
                const { data: recipient } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('card_number', recipientCard)
                    .single();

                if (!recipient) {
                    showNotification('C√≠mzett nem tal√°lhat√≥!', 'error');
                    return;
                }

                // Egyenleg ellen≈ërz√©se (admin-nak nincs korl√°toz√°s)
                if (!currentUser.is_admin && currentUser.balance < amount) {
                    showNotification('Nincs elegend≈ë fedezet!', 'error');
                    return;
                }

                // K√ºld≈ë egyenleg√©nek friss√≠t√©se (ha nem admin)
                if (!currentUser.is_admin) {
                    const { error: senderError } = await supabaseClient
                        .from('users')
                        .update({ balance: currentUser.balance - amount })
                        .eq('card_number', currentUser.card_number);

                    if (senderError) {
                        showNotification('Hiba az √°tutal√°sn√°l!', 'error');
                        return;
                    }
                    currentUser.balance -= amount;
                }

                // C√≠mzett egyenleg√©nek friss√≠t√©se
                const { error: recipientError } = await supabaseClient
                    .from('users')
                    .update({ balance: recipient.balance + amount })
                    .eq('card_number', recipientCard);

                if (recipientError) {
                    showNotification('Hiba az √°tutal√°sn√°l!', 'error');
                    return;
                }

                updateUserInfo();
                showNotification(`Sikeres √°tutal√°s: ${amount} JG k√ºldve ${recipient.name} r√©sz√©re!`, 'success');
                
                // Form t√∂rl√©se
                document.getElementById('recipientCard').value = '';
                document.getElementById('amount').value = '';

            } catch (error) {
                showNotification('√Åtutal√°si hiba: ' + error.message, 'error');
            }
        }

        async function requestMoney() {
            const amount = parseFloat(document.getElementById('requestAmount').value);
            const reason = document.getElementById('requestReason').value;

            if (amount <= 0 || isNaN(amount) || !reason.trim()) {
                showNotification('K√©rj√ºk, adj meg √©rv√©nyes √∂sszeget √©s indokl√°st!', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('money_requests')
                    .insert({
                        user_id: currentUser.card_number,
                        user_name: currentUser.name,
                        amount: amount,
                        reason: reason,
                        status: 'pending'
                    });

                if (error) {
                    showNotification('Hiba a k√©r√©s k√ºld√©s√©n√©l!', 'error');
                    return;
                }

                showNotification('K√©r√©s sikeresen elk√ºldve az adminnak!', 'success');
                document.getElementById('requestAmount').value = '';
                document.getElementById('requestReason').value = '';

            } catch (error) {
                showNotification('Hiba: ' + error.message, 'error');
            }
        }

        async function adminTransfer() {
            const userCard = document.getElementById('userCardNumber').value;
            const amount = parseFloat(document.getElementById('adminAmount').value);

            if (!userCard || amount <= 0 || isNaN(amount)) {
                showNotification('K√©rj√ºk, adj meg √©rv√©nyes adatokat!', 'error');
                return;
            }

            try {
                const { data: user } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('card_number', userCard)
                    .single();

                if (!user) {
                    showNotification('Felhaszn√°l√≥ nem tal√°lhat√≥!', 'error');
                    return;
                }

                const { error } = await supabaseClient
                    .from('users')
                    .update({ balance: user.balance + amount })
                    .eq('card_number', userCard);

                if (error) {
                    showNotification('Hiba az √°tutal√°sn√°l!', 'error');
                    return;
                }

                showNotification(`Sikeres √°tutal√°s: ${amount} JG k√ºldve ${user.name} r√©sz√©re!`, 'success');
                document.getElementById('userCardNumber').value = '';
                document.getElementById('adminAmount').value = '';

            } catch (error) {
                showNotification('Admin √°tutal√°si hiba: ' + error.message, 'error');
            }
        }

        async function viewUserAccount() {
            const userCard = document.getElementById('viewUserCard').value;

            if (!userCard) {
                showNotification('Add meg a felhaszn√°l√≥ k√°rtyasz√°m√°t!', 'error');
                return;
            }

            try {
                const { data: user } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('card_number', userCard)
                    .single();

                if (!user) {
                    showNotification('Felhaszn√°l√≥ nem tal√°lhat√≥!', 'error');
                    return;
                }

                showNotification(`${user.name} - Egyenleg: ${user.balance} JG`, 'success');

            } catch (error) {
                showNotification('Hiba: ' + error.message, 'error');
            }
        }

        async function loadMoneyRequests() {
            try {
                const { data: requests, error } = await supabaseClient
                    .from('money_requests')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });

                if (error) {
                    showNotification('Hiba a k√©r√©sek bet√∂lt√©s√©n√©l!', 'error');
                    return;
                }

                updateRequestsList(requests || []);

            } catch (error) {
                showNotification('Hiba: ' + error.message, 'error');
            }
        }

        function updateRequestsList(requests) {
            const requestsContainer = document.getElementById('requestsList');
            
            if (requests.length === 0) {
                requestsContainer.innerHTML = '<p>Nincs f√ºgg≈ëben l√©v≈ë k√©r√©s.</p>';
                return;
            }

            let html = '';
            requests.forEach(request => {
                html += `
                    <div class="request-item">
                        <p><strong>Felhaszn√°l√≥:</strong> ${request.user_name} (${request.user_id})</p>
                        <p><strong>√ñsszeg:</strong> ${request.amount} JG</p>
                        <p><strong>Indokl√°s:</strong> ${request.reason}</p>
                        <p><strong>D√°tum:</strong> ${new Date(request.created_at).toLocaleString('hu-HU')}</p>
                        <div class="button-group">
                            <button onclick="handleRequest(${request.id}, true)">Elfogad√°s</button>
                            <button onclick="handleRequest(${request.id}, false)">Elutas√≠t√°s</button>
                        </div>
                    </div>
                `;
            });

            requestsContainer.innerHTML = html;
        }

        async function handleRequest(requestId, approved) {
            try {
                // K√©r√©s adatainak lek√©r√©se
                const { data: request } = await supabaseClient
                    .from('money_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();

                if (!request) {
                    showNotification('K√©r√©s nem tal√°lhat√≥!', 'error');
                    return;
                }

                if (approved) {
                    // Felhaszn√°l√≥ egyenleg√©nek friss√≠t√©se
                    const { data: user } = await supabaseClient
                        .from('users')
                        .select('balance')
                        .eq('card_number', request.user_id)
                        .single();

                    await supabaseClient
                        .from('users')
                        .update({ balance: user.balance + request.amount })
                        .eq('card_number', request.user_id);

                    showNotification(`${request.amount} JG j√≥v√°√≠rva ${request.user_name} sz√°m√°ra!`, 'success');
                } else {
                    showNotification('K√©r√©s elutas√≠tva!', 'error');
                }

                // K√©r√©s st√°tusz√°nak friss√≠t√©se
                await supabaseClient
                    .from('money_requests')
                    .update({ status: approved ? 'approved' : 'rejected' })
                    .eq('id', requestId);

                // K√©r√©sek list√°j√°nak friss√≠t√©se
                loadMoneyRequests();

            } catch (error) {
                showNotification('Hiba a k√©r√©s feldolgoz√°s√°n√°l: ' + error.message, 'error');
            }
        }

        async function logout() {
            currentUser = null;
            allUsers = [];
            document.getElementById('bankInterface').classList.add('hidden');
            document.getElementById('authForms').classList.remove('hidden');
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('userTabs').classList.add('hidden');
            document.getElementById('cardNumber').value = '';
            document.getElementById('pin').value = '';
            showTab('loginForm');
            showNotification('Sikeresen kijelentkezt√©l!', 'success');
        }

        // Felhaszn√°l√≥k bet√∂lt√©se (norm√°l felhaszn√°l√≥knak)
        async function loadUsers() {
            try {
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('card_number, name, balance')
                    .neq('card_number', currentUser.card_number)
                    .neq('card_number', 'admin')
                    .order('name');

                if (error) {
                    showNotification('Hiba a felhaszn√°l√≥k bet√∂lt√©s√©n√©l!', 'error');
                    return;
                }

                allUsers = users || [];
                displayUsersList(users || []);

            } catch (error) {
                showNotification('Hiba: ' + error.message, 'error');
            }
        }

        // √ñsszes felhaszn√°l√≥ bet√∂lt√©se (adminnak)
        async function loadAllUsers() {
            try {
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('card_number, name, balance, is_admin')
                    .neq('card_number', 'admin')
                    .order('name');

                if (error) {
                    showNotification('Hiba a felhaszn√°l√≥k bet√∂lt√©s√©n√©l!', 'error');
                    return;
                }

                allUsers = users || [];
                displayAllUsersList(users || []);

            } catch (error) {
                showNotification('Hiba: ' + error.message, 'error');
            }
        }

        function displayUsersList(users) {
            const usersList = document.getElementById('usersList');
            if (users.length === 0) {
                usersList.innerHTML = '<p>Nincs m√°s felhaszn√°l√≥.</p>';
                return;
            }

            let html = '';
            users.forEach(user => {
                html += `
                    <div class="user-item" onclick="selectUser('${user.card_number}', '${user.name}')">
                        <strong>${user.name}</strong> - K√°rtyasz√°m: ${user.card_number}
                    </div>
                `;
            });

            usersList.innerHTML = html;
        }

        function displayAllUsersList(users) {
            const usersList = document.getElementById('allUsersList');
            if (users.length === 0) {
                usersList.innerHTML = '<p>Nincs felhaszn√°l√≥.</p>';
                return;
            }

            let html = '';
            users.forEach(user => {
                html += `
                    <div class="user-item">
                        <strong>${user.name}</strong> - K√°rtyasz√°m: ${user.card_number} - Egyenleg: ${user.balance} JG
                        ${user.is_admin ? ' (Admin)' : ''}
                    </div>
                `;
            });

            usersList.innerHTML = html;
        }

        function selectUser(cardNumber, name) {
            document.getElementById('recipientCard').value = cardNumber;
            document.getElementById('userSuggestions').innerHTML = '';
            showNotification(`${name} kiv√°lasztva!`, 'success');
        }

        function selectAdminUser(cardNumber, name, inputId) {
            document.getElementById(inputId).value = cardNumber;
            // T√∂r√∂lj√ºk az √∂sszes suggestion div-et
            document.getElementById('adminUserSuggestions').innerHTML = '';
            document.getElementById('deductUserSuggestions').innerHTML = '';
            document.getElementById('viewUserSuggestions').innerHTML = '';
            showNotification(`${name} kiv√°lasztva!`, 'success');
        }

        // Keres√©si funkci√≥k
        function searchUsers(query) {
            const suggestions = document.getElementById('userSuggestions');
            if (query.length < 2) {
                suggestions.innerHTML = '';
                return;
            }

            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase()) ||
                user.card_number.includes(query)
            );

            let html = '';
            filteredUsers.slice(0, 5).forEach(user => {
                html += `
                    <div class="suggestion-item" onclick="selectUser('${user.card_number}', '${user.name}')">
                        ${user.name} - ${user.card_number}
                    </div>
                `;
            });

            suggestions.innerHTML = html;
        }

        function searchUsersAdmin(query) {
            const suggestions = document.getElementById('adminUserSuggestions');
            if (query.length < 2) {
                suggestions.innerHTML = '';
                return;
            }

            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase()) ||
                user.card_number.includes(query)
            );

            let html = '';
            filteredUsers.slice(0, 5).forEach(user => {
                html += `
                    <div class="suggestion-item" onclick="selectAdminUser('${user.card_number}', '${user.name}', 'userCardNumber')">
                        ${user.name} - ${user.card_number} (${user.balance} JG)
                    </div>
                `;
            });

            suggestions.innerHTML = html;
        }

        function searchUsersDeduct(query) {
            const suggestions = document.getElementById('deductUserSuggestions');
            if (query.length < 2) {
                suggestions.innerHTML = '';
                return;
            }

            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase()) ||
                user.card_number.includes(query)
            );

            let html = '';
            filteredUsers.slice(0, 5).forEach(user => {
                html += `
                    <div class="suggestion-item" onclick="selectAdminUser('${user.card_number}', '${user.name}', 'deductUserCard')">
                        ${user.name} - ${user.card_number} (${user.balance} JG)
                    </div>
                `;
            });

            suggestions.innerHTML = html;
        }

        function searchUsersView(query) {
            const suggestions = document.getElementById('viewUserSuggestions');
            if (query.length < 2) {
                suggestions.innerHTML = '';
                return;
            }

            const filteredUsers = allUsers.filter(user => 
                user.name.toLowerCase().includes(query.toLowerCase()) ||
                user.card_number.includes(query)
            );

            let html = '';
            filteredUsers.slice(0, 5).forEach(user => {
                html += `
                    <div class="suggestion-item" onclick="selectAdminUser('${user.card_number}', '${user.name}', 'viewUserCard')">
                        ${user.name} - ${user.card_number} (${user.balance} JG)
                    </div>
                `;
            });

            suggestions.innerHTML = html;
        }

        // Admin p√©nz levon√°si funkci√≥
        async function adminDeduct() {
            const userCard = document.getElementById('deductUserCard').value;
            const amount = parseFloat(document.getElementById('deductAmount').value);

            if (!userCard || amount <= 0 || isNaN(amount)) {
                showNotification('K√©rj√ºk, adj meg √©rv√©nyes adatokat!', 'error');
                return;
            }

            try {
                const { data: user } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('card_number', userCard)
                    .single();

                if (!user) {
                    showNotification('Felhaszn√°l√≥ nem tal√°lhat√≥!', 'error');
                    return;
                }

                if (user.balance < amount) {
                    showNotification('A felhaszn√°l√≥nak nincs elegend≈ë egyenlege!', 'error');
                    return;
                }

                const { error } = await supabaseClient
                    .from('users')
                    .update({ balance: user.balance - amount })
                    .eq('card_number', userCard);

                if (error) {
                    showNotification('Hiba a p√©nz levon√°s√°n√°l!', 'error');
                    return;
                }

                showNotification(`Sikeres levon√°s: ${amount} JG levonva ${user.name} sz√°ml√°r√≥l!`, 'success');
                document.getElementById('deductUserCard').value = '';
                document.getElementById('deductAmount').value = '';
                
                // Friss√≠tj√ºk a felhaszn√°l√≥k list√°j√°t
                loadAllUsers();

            } catch (error) {
                showNotification('Admin levon√°si hiba: ' + error.message, 'error');
            }
        }

        // Kezdeti be√°ll√≠t√°s
        showTab('loginForm');
    </script>
</body>
</html>
