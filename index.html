<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>KNB Bank</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand: purple; --brand-dark:#660066; }
    body { font-family: Arial, sans-serif; background:#fff; color:var(--brand); margin:0; padding:20px; }
    .container { max-width:1200px; margin:0 auto; }
    .header { text-align:center; padding:20px; border-bottom:2px solid var(--brand); margin-bottom:20px; }
    .form-group { margin-bottom:12px; }
    input, textarea, select {
      width:100%; padding:10px; border:1px solid var(--brand); border-radius:4px; box-sizing:border-box;
    }
    button {
      width:100%; padding:10px 16px; border:0; border-radius:4px; background:var(--brand); color:#fff; cursor:pointer;
    }
    button:hover { background:var(--brand-dark); }
    button:disabled { background:#bbb; cursor:not-allowed; }
    .hidden { display:none; }
    .row { display:flex; gap:20px; }
    .col { flex:1; }
    #userInfo { padding:12px; border:1px solid var(--brand); border-radius:6px; }
    .tab-buttons { display:flex; gap:10px; margin:16px 0; }
    .tab-buttons button { flex:1; }
    .panel { padding:12px; border:1px solid var(--brand); border-radius:6px; background:#fafafa; }
    .transactions-panel { max-height:600px; overflow:auto; }
    .transaction-item {
      background:#fff; border-left:4px solid var(--brand); margin:10px 0; padding:10px; border-radius:6px;
      box-shadow:0 2px 4px rgba(0,0,0,.08);
    }
    .transaction-item .amount { font-weight:bold; margin:6px 0; }
    .positive { color:#2e7d32; } .negative { color:#c62828; }
    .date { color:#555; font-size:.9em; }
    .notification {
      position:fixed; top:20px; right:20px; padding:12px 16px; border-radius:6px; display:none; z-index:999;
      color:#fff;
    }
    .success { background:#2e7d32; } .error { background:#c62828; } .info { background:#1976d2; }

    /* lists */
    .list { display:flex; flex-direction:column; gap:8px; }
    .list-item {
      background:#fff; border:1px solid #e6d9f5; border-radius:6px; padding:10px;
      display:flex; flex-wrap:wrap; align-items:center; gap:10px; justify-content:space-between;
    }
    .actions { display:flex; gap:8px; }
    .split { display:flex; gap:20px; }
    .muted { color:#666; }
    .badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:.85em; background:#eee; color:#333; }
  </style>
</head>
<body>
  <div id="notification" class="notification"></div>

  <div class="container">
    <div class="header">
      <h1>KNB Bank</h1>
      <p>Üdv a KNB-ben – Jukasgaras (JG) – gyorsan, tisztán, magyar idővel.</p>
    </div>

    <!-- Loading -->
    <div id="loadingScreen"><h3>Kapcsolódás az adatbázishoz…</h3></div>

    <!-- Auth -->
    <div id="authForms" class="hidden">
      <div class="tab-buttons">
        <button onclick="showTab('loginForm')" id="loginTab">Bejelentkezés</button>
        <button onclick="showTab('registrationForm')" id="registrationTab">Regisztráció</button>
      </div>

      <div id="loginForm">
        <h2>Bejelentkezés</h2>
        <div class="form-group"><input type="text" id="cardNumber" placeholder="Kártyaszám"></div>
        <div class="form-group"><input type="password" id="pin" placeholder="PIN kód"></div>
        <button onclick="login()">Belépés</button>
      </div>

      <div id="registrationForm" class="hidden">
        <h2>Regisztráció</h2>
        <div class="form-group"><input type="text" id="regName" placeholder="Teljes név"></div>
        <div class="form-group"><input type="password" id="regPin" placeholder="PIN (4 számjegy)"></div>
        <div class="form-group"><input type="password" id="regPinConfirm" placeholder="PIN megerősítése"></div>
        <button onclick="register()">Regisztráció</button>
      </div>
    </div>

    <!-- App -->
    <div id="bankInterface" class="hidden">
      <div class="row">
        <div class="col">
          <div id="userInfo" class="panel">
            <h3>Felhasználói információk</h3>
            <p>Név: <strong id="displayName"></strong></p>
            <p>Kártyaszám: <strong id="displayCardNumber"></strong></p>
            <p>Egyenleg: <strong id="balance"></strong> JG</p>
          </div>

          <div class="tab-buttons" id="userTabs">
            <button onclick="showUserTab('transferTab')" id="t1">Átutalás</button>
            <button onclick="showUserTab('requestTab')" id="t2">Pénz kérése</button>
            <button onclick="showUserTab('directoryTab')" id="t3">Felhasználók</button>
          </div>

          <!-- Transfer -->
          <div id="transferTab" class="panel">
            <h3>Átutalás</h3>
            <div class="form-group"><input type="text" id="recipientCard" placeholder="Címzett kártyaszáma"></div>
            <div class="form-group"><input type="number" id="amount" placeholder="Összeg (JG)"></div>
            <button onclick="transfer()">Átutalás</button>
          </div>

          <!-- Request Money -->
          <div id="requestTab" class="panel hidden">
            <h3>Pénz kérése</h3>
            <div class="form-group"><input type="number" id="requestAmount" placeholder="Kért összeg (JG)"></div>
            <div class="form-group"><textarea id="requestReason" placeholder="Indoklás"></textarea></div>
            <button onclick="requestMoney()">Kérés elküldése</button>
          </div>

          <!-- Directory -->
          <div id="directoryTab" class="panel hidden">
            <h3>Felhasználók névjegyzéke</h3>
            <div id="directoryList" class="list"></div>
          </div>

          <button onclick="logout()" style="margin-top:16px;">Kijelentkezés</button>
        </div>

        <!-- Transactions -->
        <div class="col" style="max-width:380px;">
          <div class="panel transactions-panel">
            <h3>Tranzakciók</h3>
            <div id="transactionsList"><p class="muted">Nincsenek tranzakciók</p></div>
          </div>
        </div>
      </div>

      <!-- Admin Panel -->
      <div id="adminPanel" class="panel hidden" style="margin-top:20px;">
        <h2>Admin felület</h2>

        <div class="split">
          <div class="col">
            <h3>Felhasználók (egyenleggel)</h3>
            <div class="form-group"><input type="text" id="userSearch" placeholder="Keresés név vagy kártyaszám alapján" oninput="filterAdminUsers()" /></div>
            <div id="adminUsersList" class="list"></div>
          </div>

          <div class="col">
            <h3>Pénzkérelmek</h3>
            <div id="requestsList" class="list"></div>
          </div>
        </div>

        <h3 style="margin-top:20px;">Tranzakció napló (admin szemszög)</h3>
        <div id="adminTransactions" class="list"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    /* ===== Supabase init (anon kulcs kéréssel) ===== */
    const supabaseUrl = 'https://jeorhpbjbmfuyqkaztgc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Implb3JocGJqYm1mdXlxa2F6dGdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1MTMxMTYsImV4cCI6MjA3MTA4OTExNn0.XegR7Cm3yBBVGwxtax1Dv9kDhuMoQRgS-NbFrv8dt68';
    let supabaseClient;
    let currentUser = null;
    const HUF = new Intl.NumberFormat('hu-HU');

    // Magyar idő formázó – mindig Europe/Budapest, nincs -2 óra csúszás
    const HU_TIME = new Intl.DateTimeFormat('hu-HU', { timeZone: 'Europe/Budapest', dateStyle: 'short', timeStyle: 'medium' });
    function formatHU(dateStrOrDate) {
      const d = (dateStrOrDate instanceof Date) ? dateStrOrDate : new Date(dateStrOrDate);
      return HU_TIME.format(d);
    }

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function byId(id){ return document.getElementById(id); }
    function notify(msg, type='info'){
      const n = byId('notification');
      n.textContent = msg; n.className = `notification ${type}`; n.style.display = 'block';
      setTimeout(()=> n.style.display='none', 3500);
    }

    window.addEventListener('load', async () => {
      try {
        supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        hide(byId('loadingScreen'));
        show(byId('authForms'));
        showTab('loginForm');
      } catch (e) {
        console.error(e);
        notify('Nem sikerült a kapcsolódás.', 'error');
      }
    });

    /* ===== Auth UI ===== */
    function showTab(tab) {
      ['loginForm','registrationForm'].forEach(id=>hide(byId(id)));
      show(byId(tab));
    }
    function showUserTab(tabId) {
      ['transferTab','requestTab','directoryTab'].forEach(id=>hide(byId(id)));
      show(byId(tabId));
    }

    /* ===== Auth actions ===== */
    async function register() {
      const name = byId('regName').value.trim();
      const pin = byId('regPin').value.trim();
      const pin2 = byId('regPinConfirm').value.trim();
      if(!name || !/^\d{4}$/.test(pin) || pin !== pin2){
        notify('Érvénytelen regisztrációs adatok.', 'error'); return;
      }
      const card = await generateUniqueCardNumber();
      const { error } = await supabaseClient.from('users').insert({
        card_number: card, pin, name, balance: 0, is_admin: false
      });
      if(error){ console.error(error); notify('Regisztráció sikertelen.', 'error'); return; }
      notify(`Sikeres regisztráció. Kártyaszám: ${card}`, 'success');
      showTab('loginForm');
      byId('cardNumber').value = card;
    }

    async function login() {
      const card = byId('cardNumber').value.trim();
      const pin  = byId('pin').value.trim();
      const { data: user, error } = await supabaseClient
        .from('users').select('*')
        .eq('card_number', card).eq('pin', pin).single();
      if(error || !user){ notify('Hibás kártyaszám vagy PIN.', 'error'); return; }
      currentUser = user;
      hide(byId('authForms')); show(byId('bankInterface'));
      // Fill info
      byId('displayName').textContent = user.name;
      byId('displayCardNumber').textContent = user.card_number;
      byId('balance').textContent = HUF.format(user.balance);
      // Load screens
      await Promise.all([loadTransactions(), loadDirectory()]);
      if(user.is_admin){ showAdmin(); } else { hide(byId('adminPanel')); }
    }

    function logout(){
      currentUser = null;
      hide(byId('bankInterface')); show(byId('authForms')); showTab('loginForm');
      notify('Kijelentkezve.', 'info');
    }

    /* ===== Helpers ===== */
    async function generateUniqueCardNumber(){
      // KNB + random 6 számjegy
      const make = () => 'KNB' + Math.floor(100000 + Math.random()*900000);
      let card = make();
      // ütközés ellenőrzés
      let exists = true;
      while(exists){
        const { data } = await supabaseClient.from('users').select('card_number').eq('card_number', card).maybeSingle();
        if(!data) exists = false; else card = make();
      }
      return card;
    }

    async function recordTransaction(user_id, type, amount, description, related_user=null){
      const { error } = await supabaseClient.from('transactions').insert({
        user_id, transaction_type: type, amount, description, related_user
      });
      if(error) console.error('Tranzakció mentési hiba:', error);
    }

    /* ===== Transactions (user) ===== */
    async function loadTransactions(){
      const { data: txs } = await supabaseClient
        .from('transactions')
        .select('*')
        .eq('user_id', currentUser.card_number)
        .order('created_at', { ascending:false });
      renderTransactions('transactionsList', txs || []);
    }

    function renderTransactions(containerId, txs){
      const c = byId(containerId);
      if(!txs || txs.length===0){ c.innerHTML = '<p class="muted">Nincsenek tranzakciók</p>'; return; }
      c.innerHTML = txs.map(t=>{
        let cls='positive', sign='+';
        if(t.amount < 0){ cls='negative'; sign=''; } // amount már előjeles
        return `<div class="transaction-item">
          <div><strong>${escapeHtml(t.description||'Tranzakció')}</strong></div>
          <div class="amount ${cls}">${sign}${HUF.format(t.amount)} JG</div>
          <div class="date">${formatHU(t.created_at)}</div>
          ${t.related_user? `<div class="muted">Kapcsolódó: ${escapeHtml(t.related_user)}</div>`:''}
        </div>`;
      }).join('');
    }

    /* ===== Directory (user) ===== */
    async function loadDirectory(){
      const { data: users } = await supabaseClient
        .from('users')
        .select('name, card_number')
        .neq('card_number', currentUser.card_number)
        .order('name', { ascending:true });
      const list = byId('directoryList');
      if(!users || users.length===0){ list.innerHTML = '<p class="muted">Még nincsenek más felhasználók.</p>'; return; }
      list.innerHTML = users.map(u=>`
        <div class="list-item">
          <div><strong>${escapeHtml(u.name)}</strong> <span class="badge">${escapeHtml(u.card_number)}</span></div>
          <div class="actions">
            <button onclick="prefillTransfer('${u.card_number}')">Küldés neki</button>
          </div>
        </div>
      `).join('');
    }
    function prefillTransfer(card){ showUserTab('transferTab'); byId('recipientCard').value = card; }

    /* ===== Money transfer / request (user) ===== */
    async function transfer(){
      const recipientCard = byId('recipientCard').value.trim();
      const amount = parseFloat(byId('amount').value);
      if(!recipientCard || !amount || amount<=0){ notify('Adj meg érvényes összeget és címzettet.', 'error'); return; }
      if(recipientCard === currentUser.card_number){ notify('Magadnak nem utalhatsz.', 'error'); return; }

      const { data: recipient } = await supabaseClient.from('users').select('*').eq('card_number', recipientCard).maybeSingle();
      if(!recipient){ notify('Nincs ilyen kártyaszám.', 'error'); return; }
      if(currentUser.balance < amount){ notify('Nincs elég egyenleg.', 'error'); return; }

      // egyenlegek
      await supabaseClient.from('users').update({ balance: currentUser.balance - amount }).eq('card_number', currentUser.card_number);
      await supabaseClient.from('users').update({ balance: recipient.balance + amount }).eq('card_number', recipientCard);

      // tranzakciók
      await recordTransaction(currentUser.card_number, 'transfer_sent', -amount, `Átutalás ${recipient.name} részére`, recipient.card_number);
      await recordTransaction(recipient.card_number, 'transfer_received', amount, `Átutalás ${currentUser.name}-tól`, currentUser.card_number);

      currentUser.balance -= amount;
      byId('balance').textContent = HUF.format(currentUser.balance);
      await loadTransactions();
      notify('Átutalás sikeres.', 'success');
      byId('amount').value = '';
    }

    async function requestMoney(){
      const amount = parseFloat(byId('requestAmount').value);
      const reason = byId('requestReason').value.trim();
      if(!amount || amount<=0 || !reason){ notify('Adj meg összeget és indoklást.', 'error'); return; }
      await supabaseClient.from('money_requests').insert({
        user_id: currentUser.card_number, user_name: currentUser.name,
        amount, reason, status: 'pending'
      });
      // fontos: itt NEM 0-t írunk be, hanem a kért összeget
      await recordTransaction(currentUser.card_number, 'money_request', amount, `Pénzkérés: ${reason}`, 'admin');
      await loadTransactions();
      notify('Pénzkérés elküldve.', 'success');
      byId('requestAmount').value=''; byId('requestReason').value='';
    }

    /* ===== Admin ===== */
    function showAdmin(){
      show(byId('adminPanel'));
      loadAdminUsers();
      loadRequests();
      loadAdminTransactions();
    }

    async function loadAdminUsers(){
      const { data: users } = await supabaseClient
        .from('users')
        .select('name, card_number, balance, is_admin')
        .order('name', { ascending:true });
      renderAdminUsers(users||[]);
    }

    let _adminUsersCache = [];
    function renderAdminUsers(users){
      _adminUsersCache = users;
      const list = byId('adminUsersList');
      if(users.length===0){ list.innerHTML='<p class="muted">Nincs felhasználó.</p>'; return; }
      list.innerHTML = users.map(u=>`
        <div class="list-item">
          <div>
            <strong>${escapeHtml(u.name)}</strong>
            <span class="badge">${escapeHtml(u.card_number)}</span>
            ${u.is_admin ? '<span class="badge">ADMIN</span>' : ''}
            <div class="muted">Egyenleg: ${HUF.format(u.balance)} JG</div>
          </div>
          <div class="actions" style="min-width:320px;">
            <input type="number" placeholder="Összeg (JG)" id="adm_amt_${u.card_number}" style="width:130px;">
            <button onclick="adminCredit('${u.card_number}')">Jóváír</button>
            <button onclick="adminDebit('${u.card_number}')">Levon</button>
          </div>
        </div>
      `).join('');
    }

    function filterAdminUsers(){
      const q = byId('userSearch').value.toLowerCase();
      const filtered = _adminUsersCache.filter(u =>
        u.name.toLowerCase().includes(q) || u.card_number.toLowerCase().includes(q)
      );
      renderAdminUsers(filtered);
    }

    async function adminCredit(card){
      const inp = byId(`adm_amt_${card}`); const amount = parseFloat(inp.value);
      if(!amount || amount<=0){ notify('Adj meg érvényes összeget.', 'error'); return; }
      const { data: u } = await supabaseClient.from('users').select('*').eq('card_number', card).single();
      await supabaseClient.from('users').update({ balance: u.balance + amount }).eq('card_number', card);
      await recordTransaction(card, 'admin_credit', amount, `Admin jóváírás (${currentUser.name})`, currentUser.card_number);
      notify('Jóváírás kész.', 'success'); inp.value='';
      if(card === currentUser.card_number){ currentUser.balance += amount; byId('balance').textContent = HUF.format(currentUser.balance); }
      await Promise.all([loadAdminUsers(), loadAdminTransactions()]);
    }

    async function adminDebit(card){
      const inp = byId(`adm_amt_${card}`); const amount = parseFloat(inp.value);
      if(!amount || amount<=0){ notify('Adj meg érvényes összeget.', 'error'); return; }
      const { data: u } = await supabaseClient.from('users').select('*').eq('card_number', card).single();
      const newBal = (u.balance - amount);
      await supabaseClient.from('users').update({ balance: newBal }).eq('card_number', card);
      await recordTransaction(card, 'admin_debit', -amount, `Admin levonás (${currentUser.name})`, currentUser.card_number);
      notify('Levonás kész.', 'success'); inp.value='';
      if(card === currentUser.card_number){ currentUser.balance -= amount; byId('balance').textContent = HUF.format(currentUser.balance); }
      await Promise.all([loadAdminUsers(), loadAdminTransactions()]);
    }

    async function loadRequests(){
      const { data: reqs } = await supabaseClient
        .from('money_requests')
        .select('*')
        .order('created_at', { ascending:false });
      const list = byId('requestsList');
      if(!reqs || reqs.length===0){ list.innerHTML = '<p class="muted">Nincs pénzkérelem.</p>'; return; }
      list.innerHTML = reqs.map(r=>`
        <div class="list-item">
          <div>
            <strong>${escapeHtml(r.user_name)}</strong>
            <span class="badge">${escapeHtml(r.user_id)}</span>
            <div>Kért összeg: <strong>${HUF.format(r.amount)} JG</strong></div>
            <div class="muted">${escapeHtml(r.reason || '')}</div>
            <div class="muted">Kelte: ${formatHU(r.created_at)}</div>
            <div>Státusz: <span class="badge">${escapeHtml(r.status)}</span></div>
          </div>
          <div class="actions">
            <button onclick="approveRequest('${r.id}','${r.user_id}','${encodeURIComponent(r.user_name)}',${r.amount})" ${r.status!=='pending'?'disabled':''}>Jóváhagy</button>
            <button onclick="rejectRequest('${r.id}')" ${r.status!=='pending'?'disabled':''}>Elutasít</button>
          </div>
        </div>
      `).join('');
    }

    async function approveRequest(id, user_id, user_name_enc, amount){
      const user_name = decodeURIComponent(user_name_enc);
      // update status
      await supabaseClient.from('money_requests').update({ status: 'approved' }).eq('id', id);
      // update balance
      const { data: u } = await supabaseClient.from('users').select('*').eq('card_number', user_id).single();
      await supabaseClient.from('users').update({ balance: u.balance + amount }).eq('card_number', user_id);
      // transactions
      await recordTransaction(user_id, 'request_approved', amount, `Kérelem jóváhagyva (${currentUser.name})`, currentUser.card_number);
      notify(`Kérelem jóváhagyva: ${user_name}`, 'success');
      await Promise.all([loadRequests(), loadAdminUsers(), loadAdminTransactions()]);
    }

    async function rejectRequest(id){
      await supabaseClient.from('money_requests').update({ status: 'rejected' }).eq('id', id);
      notify('Kérelem elutasítva.', 'info');
      await loadRequests();
    }

    async function loadAdminTransactions(){
      const { data: txs } = await supabaseClient
        .from('transactions')
        .select('*')
        .or('transaction_type.eq.admin_credit,transaction_type.eq.admin_debit,transaction_type.eq.request_approved')
        .order('created_at', { ascending:false })
        .limit(100);
      renderTransactions('adminTransactions', txs || []);
    }

    /* ===== Utils ===== */
    function escapeHtml(s=''){
      return s.replace(/[&<>"']/g, m=>({ '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#039;' }[m]));
    }
  </script>
</body>
</html>
